<script type="text/javascript">
	easyloader.load(['productserial'], function(){		
		var bd = ebx.cloneObj(ebx.bd);
		bd.showSearchserial = 1;
		bd.init('center', function(c, s){
			ebx.setDatagridEditor.editorType(c[0], 'productname', 'combogrid', {//用来选择菜单组的combogrid
				style:'product',
				//validType:'LetterInteger',
				remoteSort:false,
				required:true,
				idField:'id',
				idField:'productname',
				rownumbers:true,
				panelWidth:400,
				panelHeight:300,
				droplisturl:'server/SimpChinese/product/open/',
				hasDownArrow:false,//隐藏右边得下箭头
				//template:147,
				onCheck: function(rowIndex,rowData){//选中后更新当前行的内容为选中内容
					var r = s.datagrid('getData');
					r.firstRows[s.datagrid('options').editIndex].serial = r.firstRows.length;
					r.firstRows[s.datagrid('options').editIndex].productid = ebx.validInt(rowData.productid);
					r.firstRows[s.datagrid('options').editIndex].productcode = rowData.productcode;
					r.firstRows[s.datagrid('options').editIndex].spec = rowData.spec;
					r.firstRows[s.datagrid('options').editIndex].unit = rowData.unit;
					r.firstRows[s.datagrid('options').editIndex].aunit = rowData.aunit;
					r.firstRows[s.datagrid('options').editIndex].oldprice = ebx.validFloat(rowData.detailprice);
					r.firstRows[s.datagrid('options').editIndex].relation = ebx.validFloat(rowData.relation);
					r.firstRows[s.datagrid('options').editIndex].aquantity = ebx.validFloat(rowData.relation * 1);
					r.firstRows[s.datagrid('options').editIndex].quantity = 1;
					r.firstRows[s.datagrid('options').editIndex].price = ebx.validFloat(rowData.detailprice);
					r.firstRows[s.datagrid('options').editIndex].amount = ebx.validFloat(rowData.detailprice);
					r.firstRows[s.datagrid('options').editIndex].taxrate = ebx.validFloat(rowData.taxrate);
					r.firstRows[s.datagrid('options').editIndex].productserial = rowData.productserial;
					r.firstRows[s.datagrid('options').editIndex].lengthserial = rowData.lengthserial;
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'Quantity', 'textbox', {//处理编辑数量时的运算
				onChange: function(newValue, oldValue){
					if(newValue != oldValue){
						var data = s.datagrid('getData'),
							r = s.datagrid('getSelected'),
							index = s.datagrid('getRowIndex', r),
							quantity = ebx.validFloat(newValue);

						if(data.firstRows[index] != undefined){
							var TaxRate = ebx.validFloat(data.firstRows[index].taxrate);
							data.firstRows[index].aquantity = ebx.validFloat(data.firstRows[index].relation) * quantity;
							data.firstRows[index].amount = ebx.validFloat(data.firstRows[index].price) * quantity;
							if(TaxRate != -1){
								data.firstRows[index].taxamount = data.firstRows[index].amount / (TaxRate + 1) * TaxRate;
							}else{
								data.firstRows[index].taxamount = 0;
							}
							data.firstRows[index].nat = data.firstRows[index].amount - data.firstRows[index].taxamount;
						}
					}
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'price', 'textbox', {//处理编辑数量时的运算
				onChange: function(newValue, oldValue){
					if(newValue != oldValue){
						var data = s.datagrid('getData'),
							r = s.datagrid('getSelected'),
							index = s.datagrid('getRowIndex', r),
							price = ebx.validFloat(newValue);
						
						if(data.firstRows[index] != undefined){
							var TaxRate = ebx.validFloat(data.firstRows[index].taxrate);
							data.firstRows[index].amount = ebx.validFloat(data.firstRows[index].quantity) * price
							if(TaxRate != -1){
								data.firstRows[index].taxamount = data.firstRows[index].amount / (TaxRate + 1) * TaxRate;
							}else{
								data.firstRows[index].taxamount = 0;
							}
							data.firstRows[index].nat = data.firstRows[index].amount - data.firstRows[index].taxamount;
						}
					}
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'amount', 'textbox', {//处理编辑金额时的运算
				onChange: function(newValue, oldValue){
					if(newValue != oldValue){
						var data = s.datagrid('getData'),
							r = s.datagrid('getSelected'),
							index = s.datagrid('getRowIndex', r),
							amount = ebx.validFloat(newValue);
						
						if(data.firstRows[index] != undefined){
							var quantity = ebx.validFloat(data.firstRows[index].quantity),
								TaxRate = ebx.validFloat(data.firstRows[index].taxrate);
							if(quantity == 0){
								data.firstRows[index].price = 0
							}else{
								data.firstRows[index].price = amount/quantity;
							}
							if(TaxRate != -1){
								data.firstRows[index].taxamount = data.firstRows[index].amount / (TaxRate + 1) * TaxRate;
							}else{
								data.firstRows[index].taxamount = 0;
							}
							data.firstRows[index].nat = data.firstRows[index].amount - data.firstRows[index].taxamount;
						}
					}
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'expire', 'datebox', {});//处理质保期

			ebx.setDatagridEditor.editorType(c[0], 'ProductSerial', '', {});//清除串号编辑功能
			ebx.setDatagridEditor.editorType(c[0], 'ColorSize', '', {});//清除色码编辑功能
			ebx.setDatagridEditor.editorType(c[0], 'ProductCode', '', {});//清除串号编辑功能
			
			ebx.setDatagridEditor.setColumnsFunc(c[0], 'expire', 'cbRSDate');//写入服务器端用回掉函数
		}, function(s){
			s.datagrid('options').onClickCell = function(index, field, value){
				switch(field.toLowerCase()){//处理串号编辑
					case 'productserial':
						var productserialopen = ebx.cloneObj(ebx.productserial),//复制产品串号编辑对象
							row = s.datagrid('getData').firstRows[index];
						//productserialopen.open(row.productname, row.lengthserial, s, index);
						productserialopen.open(row.productname, row.lengthserial, s, index);
						break;
					case 'colorsize':
						var colorsizeopen = ebx.cloneObj(ebx.colorsize),//复制产品色码编辑对象
							row = s.datagrid('getData').firstRows[index];
						colorsizeopen.init(row.productname, s, index, bd.tab);
						colorsizeopen.open();
						break;
					default:
						var opts = s.datagrid('options');
						if(opts.editIndex>=0){
							s.datagrid('endEdit', opts.editIndex);
						}
						s.datagrid('selectRow', index).datagrid('editkeyboard', {index:index,field:field});
						opts.editIndex = index
						break;
				}
			}
			s.datagrid('options').onRowContextMenu = function(e, rowIndex, rowData){//鼠标右键处理方法
				if(rowIndex < 0)return;
				d = $(this);
				d.datagrid('selectRow', rowIndex)
				e.preventDefault();
				var RowContextMenu = $('<div>');
				RowContextMenu.menu({
					width:100
				}).menu('appendItem', {
					text: '查看库存',
					iconCls: 'icon-ChartTypePieInsertGallery',
					disable:true,
					onclick:function(){
						if(ebx.validInt(rowData.productid) == 0){
							$.messager.show({
								title: '错误',
								msg: '请选择产品。',
								timeout: 3000,
								showType: 'slide'
							});
							return;
						}
						var win = $('<div>').appendTo($('body')),
							stockquery = $('<div>').appendTo(win);
						win.window({
							title: rowData.productname + ' 的库存',
							width:800,    
							height:600, 
							maxWidth:'90%',
							maxHeight:'90%',
							modal:true,
							collapsible:false,
							minimizable:false,
							maximizable:false,
							resizable:false,
							border:'thin',
							shadow:false
						});
						$('body').find('.window-mask').on('click', function(){
							win.window('close');
						});
						$.ajax({
							type: 'post', 
							url: 'server/SimpChinese/DataProvider/style/',
							data: {style:'ItemBatch',_:(new Date()).getTime()},//style名称必须和mode相吻合
							dataType: "json",
							success: function(result){
								if(result){
									columnsData = [result.data];
									ebx.setListVies(columnsData[0]);
									stockquery.datagrid({
										view:scrollview,
										pageSize:ebx.pagesize,
										remoteSort:false,
										rownumbers:true,
										singleSelect:true,
										pagination:false,
										border:false,
										fit:false,
										fitColumns:false,
										striped:true,
										data:{total:0,rows:[]},
										url:'server/SimpChinese/product/stock/',
										nowrap:true,//禁用自动换行
										method:'post',
										queryParams:{_:(new Date()).getTime(),id:rowData.productid,listview:ebx.convertDicToJson(ebx.listview)},
										multiSort:false,
										checkOnSelect:false,
										columns:columnsData,
										height: '100%',
										border:result.bd[0].border,
										showFooter:result.bd[0].footer,
										showHeader:result.bd[0].header
									}).datagrid('renderformatterstyler');//启用显示式样回调函数
								}
							}
						});
					}
				}).menu('appendItem', {
					text: '删除',
					iconCls: 'icon-Delete',
					disabled:rowData.auditid?true:(rowData.isdeleted?true:false),
					onclick: function(){
						$.messager.confirm('确认对话框', '您想要删除吗？删除操作后数据将无法恢复。', function(r){
							if (r){
								d.datagrid('deleteRow', rowIndex);						
								ebx.setEditstatus(bd.tab, true);
							}
						});
					}
				}).menu('show', {
					left: e.pageX,
					top: e.pageY
				});
			}
		});
	});
</script>
