<script type="text/javascript">
	easyloader.load(['productserial'], function(){		
		var bd = ebx.cloneObj(ebx.bd);
				
		bd.init('center', function(c, s){
			ebx.setDatagridEditor.editorType(c[0], 'productname', 'combogrid', {//用来选择菜单组的combogrid
				style:'product',
				//validType:'LetterInteger',
				required:true,
				idField:'id',
				idField:'title',
				rownumbers:true,
				panelWidth:400,
				template:147,
				onCheck: function(rowIndex,rowData){//选中后更新当前行的内容为选中内容
					var r = s.datagrid('getData');
					r.rows[s.datagrid('options').editIndex].id = ebx.validInt(rowData.id);
					r.rows[s.datagrid('options').editIndex].productcode = rowData.code;
					r.rows[s.datagrid('options').editIndex].spec = rowData.nvarchar2;
					r.rows[s.datagrid('options').editIndex].unit = rowData.unit;
					r.rows[s.datagrid('options').editIndex].aunit = rowData.aunit;
					r.rows[s.datagrid('options').editIndex].oldprice = ebx.validFloat(rowData.detailprice);
					r.rows[s.datagrid('options').editIndex].relation = ebx.validFloat(rowData.relation);
					r.rows[s.datagrid('options').editIndex].aquantity = ebx.validFloat(rowData.relation * 1);
					r.rows[s.datagrid('options').editIndex].quantity = 1;
					r.rows[s.datagrid('options').editIndex].price = ebx.validFloat(rowData.detailprice);
					r.rows[s.datagrid('options').editIndex].amount = ebx.validFloat(rowData.detailprice);
					r.rows[s.datagrid('options').editIndex].taxrate = ebx.validFloat(rowData.taxrate);
					
					
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'Quantity', 'textbox', {//处理编辑数量时的运算
				onChange: function(newValue, oldValue){
					if(newValue != oldValue){
						var data = s.datagrid('getData'),
							r = s.datagrid('getSelected'),
							index = s.datagrid('getRowIndex', r),
							quantity = ebx.validFloat(newValue);

						if(data.rows[index] != undefined){
							var TaxRate = ebx.validFloat(data.rows[index].taxrate);
							data.rows[index].aquantity = ebx.validFloat(data.rows[index].relation) * quantity;
							data.rows[index].amount = ebx.validFloat(data.rows[index].price) * quantity;
							if(TaxRate != -1){
								data.rows[index].taxamount = data.rows[index].amount / (TaxRate + 1) * TaxRate;
							}else{
								data.rows[index].taxamount = 0;
							}
							data.rows[index].nat = data.rows[index].amount - data.rows[index].taxamount;
						}
					}
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'price', 'textbox', {//处理编辑数量时的运算
				onChange: function(newValue, oldValue){
					if(newValue != oldValue){
						var data = s.datagrid('getData'),
							r = s.datagrid('getSelected'),
							index = s.datagrid('getRowIndex', r),
							price = ebx.validFloat(newValue);
						
						if(data.rows[index] != undefined){
							var TaxRate = ebx.validFloat(data.rows[index].taxrate);
							data.rows[index].amount = ebx.validFloat(data.rows[index].quantity) * price
							if(TaxRate != -1){
								data.rows[index].taxamount = data.rows[index].amount / (TaxRate + 1) * TaxRate;
							}else{
								data.rows[index].taxamount = 0;
							}
							data.rows[index].nat = data.rows[index].amount - data.rows[index].taxamount;
						}
					}
				}
			});
			
			ebx.setDatagridEditor.editorType(c[0], 'amount', 'textbox', {//处理编辑金额时的运算
				onChange: function(newValue, oldValue){
					if(newValue != oldValue){
						var data = s.datagrid('getData'),
							r = s.datagrid('getSelected'),
							index = s.datagrid('getRowIndex', r),
							amount = ebx.validFloat(newValue);
						
						if(data.rows[index] != undefined){
							var quantity = ebx.validFloat(data.rows[index].quantity),
								TaxRate = ebx.validFloat(data.rows[index].taxrate);
							if(quantity == 0){
								data.rows[index].price = 0
							}else{
								data.rows[index].price = amount/quantity;
							}
							if(TaxRate != -1){
								data.rows[index].taxamount = data.rows[index].amount / (TaxRate + 1) * TaxRate;
							}else{
								data.rows[index].taxamount = 0;
							}
							data.rows[index].nat = data.rows[index].amount - data.rows[index].taxamount;
						}
					}
				}
			});

			ebx.setDatagridEditor.editorType(c[0], 'ProductSerial', '', {});//清除串号编辑功能
			ebx.setDatagridEditor.editorType(c[0], 'ColorSize', '', {});//清除色码编辑功能
			
		}, function(s){
			s.datagrid('options').onClickCell = function(index, field, value){
				switch(field.toLowerCase()){//处理串号编辑
					case 'productserial':
						var productserialopen = ebx.cloneObj(ebx.productserial);//复制产品串号编辑对象
						productserialopen.init(0, s.datagrid('getData').rows[index].productname);
						productserialopen.open(value);
						break;
					case 'colorsize':
						console.log(index);
						console.log(value);
						var win = $('<div>').appendTo(s);
						win.window({
							title: s.datagrid('getData').rows[index].productname + ' 的颜色尺码',
							width:640,    
							height:480, 
							modal:true,
							collapsible:false,
							minimizable:false,
							maximizable:false,
							resizable:false,
							border:'thin',
							shadow:false
						}); 
						$('body').find('.window-mask').on('click', function(){
							win.window('close');
						}); 
						break;
					default:
						var opts = s.datagrid('options');
						if(opts.editIndex>=0){
							s.datagrid('endEdit', opts.editIndex);
						}
						s.datagrid('selectRow', index).datagrid('editkeyboard', {index:index,field:field});
						opts.editIndex = index
						break;
				}
			}
		});
	});
</script>
