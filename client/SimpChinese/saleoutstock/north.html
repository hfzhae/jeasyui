<script type="text/javascript">
	easyloader.load([], function(){		
		var bd = ebx.cloneObj(ebx.bd);
		bd._export = function(){//重造导入方法
			$.messager.alert({
				title: '错误',
				msg: '不支持导入。',
				timeout: 3000,
				showType: 'slide'
			});
		}
		bd.billtype = 1306;
		bd.showAudit = 1;
		bd.showPrint = 1;

		bd.init('north',function(data){
			data.tabs[0].groups.push({
				title:'收款方式',
				tools:[{
					type:'toolbar',
					dir:'v',
					tools:[{
						//text:'收款方式',
						//iconAlign:'top',
						size:'large',
						iconCls:'icon-TableDrawTable-large',
						onClick: function(){
							if(ebx.validInt(bd.ID) == 0){
								$.messager.show({
									title: '提示',
									msg: '请先保存单据！',
									timeout: 3000,
									showType: 'slide'
								});
								return;
							}
							var win = $('<div>').appendTo('body'),
								toolbar = $('<div>'),
								newbtn = $('<div>').appendTo(toolbar),
								delbtn = $('<div>').appendTo(toolbar),
								clearbtn = $('<div>').appendTo(toolbar),
								savebtn = $('<div>').appendTo(toolbar),
								grid = $('<div>').appendTo(win);
							
							win.window({
								title: '收款方式',
								width:300,    
								height:400, 
								maxWidth:'90%',
								maxHeight:'90%',
								modal:true,
								collapsible:false,
								minimizable:false,
								maximizable:false,
								resizable:false,
								border:'thin',
								shadow:false
							});
							$('body').find('.window-mask').on('click', function(){
								win.window('close');
							});
							grid.datagrid({
								view:scrollview,
								pageSize:ebx.pagesize,
								url:'/server/SimpChinese/saleoutstock/getpayment/',
								queryParams:{
									id:bd.ID,
									_:(new Date()).getTime()
								},
								columns:[[    
									{field:'payment',title:'收款方式',editor:'text',width:100},
									{field:'amount',title:'金额',editor:'text',width:100,fieldstyle:'text-align:right;',render:'currencyRender'}
								]],
								toolbar: toolbar,
								border: false,
								height:'100%',
								width:'100%',
								rownumbers:true,
								singleSelect:true,
								striped:true,
								//ctrlSelect:true,
								fitColumns:true
							}).datagrid('renderformatterstyler');
							
							newbtn.linkbutton({
								text:'新行',
								iconCls:'icon-CellsInsertDialog',
								plain:true,
								onClick: function(){
									grid.datagrid('appendRow', {});
									grid.datagrid('selectRow', grid.datagrid('getData').total - 1);
									grid.datagrid('editkeyboard', {index: grid.datagrid('getData').total - 1, field:'payment'});
								}
							});
							delbtn.linkbutton({
								text:'删行',
								iconCls:'icon-CellsDelete',
								plain:true,
								onClick: function(){
									var index = grid.datagrid('getRowIndex', grid.datagrid('getSelected'));
									if(index < 0){
										$.messager.show({
											title: '提示',
											msg: '请先选中一行。',
											timeout: 3000,
											showType: 'slide'
										});									
										return;
									}
									$.messager.confirm('确认对话框', '您想要删除吗？删除操作后数据将无法恢复。', function(r){
										if (r){
											grid.datagrid('deleteRow', index);
											if(index >= grid.datagrid('getData').total && index > 0) index--;
											if(grid.datagrid('getData').total == 0 || index < 0){
												grid.datagrid('loadData', { total: 0, rows: [] }); 
											}else{
												grid.datagrid('selectRow', index);
											}
										}
									});
								}
							});
							clearbtn.linkbutton({
								text:'清空',
								iconCls:'icon-TableDelete',
								plain:true,
								onClick: function(){
									$.messager.confirm('确认对话框', '您想要清空吗？清空操作后数据将无法恢复。', function(r){
										if (r){
											grid.datagrid('loadData', { total: 0, rows: [] }); 
										}
									});
								}
							});
							savebtn.linkbutton({
								text:'保存',
								iconCls:'icon-FileSave',
								plain:true,
								onClick:function(){
									$.messager.progress({title:'正在保存...',text:''}); 
									var data = grid.datagrid('getData'),
										datastr = ebx.convertDicToJson(data);
										
									$.ajax({
										type: 'post', 
										url: 'server/SimpChinese/saleoutstock/setpayment/',
										data: {id: bd.ID, bd: datastr, _:(new Date()).getTime()},
										dataType: "json",
										success: function(result){
											$.messager.progress('close');
											if(result.result){
												$.messager.show({
													title: '提示',
													msg: '收款方式保存成功！',
													timeout: 3000,
													showType: 'slide'
												});
												grid.datagrid('load');
											}else{
												$.messager.alert({
													title: '错误',
													msg: result.msg,
													timeout: 3000,
													showType: 'slide'
												});
											}
										}
									});
								}
							});
						}
					}]
				}]
			});
		});
	});
</script>
