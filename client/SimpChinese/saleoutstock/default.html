<script type="text/javascript">
	easyloader.load([
		'propertygrid', 
		'datagridkeyboard', 
		'datagridrenderstyler', 
		'splitbutton', 
		'datetimebox', 
		'datagridkeyboard', 
		'ribbon', 
		'bd', 
		'combogrid', 
		'droplist',
		'switchbutton',
		'filebox',
		'form',
		'bdpring',
		'productserial'
	], function(){
		var bd = ebx.cloneObj(ebx.bd),
		    callback = {//回掉函数对象
		        north: function(data){//功能区域回调函数
			        data.tabs[0].groups.push({//新增收款方式功能组
				        title:'其他',
				        tools:[{
					        type:'toolbar',
					        tools:[{
						        text:'读取订单',
						        iconAlign:'top',
						        size:'large',
						        iconCls:'icon-MarkTaskComplete-large',
						        onClick: function(){
									var eastdata = bd.layout.layout('panel', 'east').find('.datagrid-f').datagrid('getRows'),
										customid = (function(){
											var id = 0;
											for(var i in eastdata){
												if(eastdata[i].field){
													if(eastdata[i].field.toLowerCase() === 'organization'){
														id = ebx.validInt(eastdata[i].value);
													}
												}
											}
											return id;
										})();

									if(customid == 0){
										$.messager.show({
											title: '提示',
											msg: '请先选择客户。',
											timeout: 3000,
											showType: 'slide'
										});
										return;
									}
									bd.layout.layout('remove', 'south');
									
									bd.layout.layout('add', {
										region: 'south',
										title:'读取订单',
										height: '40%',
										maxHeight: '50%',
										minHeight: 150,
										collapsible: true,
										iconCls:'icon-MarkTaskComplete',
										border: false,
										split: true,
										hideCollapsedContent: false,    
										tools: [{    
											iconCls:'panel-tool-close',    
											handler:function(){
												bd.layout.layout('remove', 'south');
											}    
										}],
										collapsedContent: function(title){
											var region = $(this).panel('options').region;
											if(region =='east'|| region =='center'){
												//返回标题;
											} else {
												return '<div class="panel-title layout-expand-title-down">销售订单</ div>';
											}
										},
										onCollapse: function(){
											bd.layout.find('.layout-expand-south').find('.panel-header').css({'border-right':0,'border-left':0,'border-bottom':0})
											bd.layout.find('.layout-expand-south').find('.panel-body').css({'border-right':0,'border-left':0,'border-bottom':0})
										}
									});
									
									var orderdata = $('<div>').appendTo(bd.layout.layout('panel', 'south')),
										toolbar = $('<div>'),
										searchtext = $('<div>').appendTo(toolbar),
										allselectbtn = $('<div>').appendTo(toolbar),
										cancelselectbtn = $('<div>').appendTo(toolbar),
										Reversalselectbtn = $('<div>').appendTo(toolbar),
										okbtn = $('<div>').appendTo(toolbar),
										closebtn = $('<div>'),//.appendTo(toolbar),
										okfn = function(d){
											if(!d)return;
											if(d.length == 0)return;
											var grid = bd.layout.layout('panel', 'center').find('.datagrid-f');
											if(d.length == 1){
												grid.datagrid('appendRow',{
													productid: d[0].productid,
													productname:d[0].pname,
													productcode:d[0].pcode,
													quantity:d[0].quantity,
													price:d[0].price,
													oldprice:d[0].oldprice,
													amount:d[0].amount,
													spec:d[0].spec,
													aunit:d[0].aunit,
													taxrate:d[0].taxrate,
													taxamount:d[0].amount/(1+d[0].taxrate)*d[0].taxrate,
													famount:d[0].amount,
													billlistmemo:d[0].strmemo
												});
												grid.datagrid('scrollTo', grid.datagrid('getData').total - 1);//滚动到新增的行
												grid.datagrid('selectRow', grid.datagrid('getData').total - 1);
											}else{
												var data = grid.datagrid('getData');
												if(data.firstRows){
													data = data.firstRows;
												}else{
													data = data.rows;
												}
												for(var i in d){
													data.push({
														productid: d[i].productid,
														productname:d[i].pname,
														productcode:d[i].pcode,
														quantity:d[i].quantity,
														price:d[i].price,
														oldprice:d[i].oldprice,
														amount:d[i].amount,
														spec:d[i].spec,
														aunit:d[i].aunit,
														taxrate:d[i].taxrate,
														taxamount:d[i].amount/(1+d[i].taxrate)*d[i].taxrate,
														famount:d[i].amount,
														billlistmemo:d[i].strmemo
													})
												}
												grid.datagrid('loadData',{total:data.length, rows:data});
											}
											ebx.setEditstatus(bd.tab, true);
										};
									$.ajax({
										type: 'post', 
										url: 'server/SimpChinese/DataProvider/style/',
										data: {style:'SO_Open',_:(new Date()).getTime()},
										dataType: "json",
										success: function(result){
											if(result){
												var columnsData = [result.data];
												ebx.setListVies(columnsData[0]);
												orderdata.datagrid({
													view:scrollview,
													pageSize:ebx.pagesize,
													remoteSort:true,
													rownumbers:true,
													singleSelect:false,
													pagination:false,
													fitColumns:false,
													striped:true,
													nowrap:true,//禁用自动换行
													url:'server/SimpChinese/saleoutstock/getorder/',
													method:'post',
													queryParams: {id: customid, _: (new Date()).getTime()},
													toolbar: toolbar,
													multiSort:false,
													checkOnSelect:false,
													checkOnSelect:true,
													columns:columnsData,
													height: '100%',
													//width: '100%',
													border:result.bd[0].border,
													showFooter:result.bd[0].footer,
													showHeader:result.bd[0].header,
													onClickCell:function(index, row){},
													onDblClickRow:function(index, row){
														okfn([row]);
														orderdata.datagrid('deleteRow', index);
													}
												}).datagrid('renderformatterstyler');
											}
										}
									});
									searchtext.searchbox({ 
										searcher:function(value,name){ 
											orderdata.datagrid('load', {
												id:customid,
												find: escape(value)
											})
										}, 
										prompt:'请输入搜索文本' 
									}); 
									allselectbtn.linkbutton({
										text:'全选',
										iconCls:'icon-TableInsertColumnsRightprvall',
										plain:true,
										onClick: function(){
											orderdata.datagrid('checkAll');
										}
									});
									cancelselectbtn.linkbutton({
										text:'取消选中',
										iconCls:'icon-TableDelete',
										plain:true,
										onClick:function(){
											orderdata.datagrid('uncheckAll');
										}
									});
									Reversalselectbtn.linkbutton({
										text:'反选',
										iconCls:'icon-Reversalselectbtn',
										plain:true,
										onClick: function(){
											var s = orderdata.datagrid('getSelections');
											orderdata.datagrid('checkAll');
											for(var i in s){
												orderdata.datagrid('unselectRow', orderdata.datagrid('getRowIndex', s[i]));
											}
										}
									});
									okbtn.linkbutton({
										text:'添加选中的行到单据',
										iconCls:'icon-arrow-up',
										plain:true,
										onClick: function(){
											var data = orderdata.datagrid('getSelections')
											okfn(data);
											for(var i in data){
												orderdata.datagrid('deleteRow',  orderdata.datagrid('getRowIndex', data[i]));
											}
										}
									});
									closebtn.linkbutton({
										text:'关闭',
										iconCls:'icon-DeclineInvitation',
										plain:true,
										onClick: function(){
											bd.layout.layout('remove', 'south');
										}
									});
								}
							}]
						},{
							type:'toolbar',
					        dir:'v',
					        tools:[{
						        text:'价格跟踪',
						        //iconAlign:'top',
						        //size:'large',
						        iconCls:'icon-AdpDiagramRelationships',
						        onClick: function(){
									var eastdata = bd.layout.layout('panel', 'east').find('.datagrid-f').datagrid('getRows'),
										customid = (function(){
											var id = 0;
											for(var i in eastdata){
												if(eastdata[i].field){
													if(eastdata[i].field.toLowerCase() === 'organization'){
														id = ebx.validInt(eastdata[i].value);
													}
												}
											}
											return id;
										})();

									if(customid == 0){
										$.messager.show({
											title: '提示',
											msg: '请先选择客户。',
											timeout: 3000,
											showType: 'slide'
										});
										return;
									}
									bd.layout.layout('remove', 'south');

									bd.layout.layout('add', {
										region: 'south',
										title:'价格跟踪',
										height: '40%',
										maxHeight: '50%',
										minHeight: 150,
										collapsible: true,
										iconCls:'icon-AdpDiagramRelationships',
										border: false,
										split: true,
										hideCollapsedContent: false,    
										tools: [{    
											iconCls:'panel-tool-close',    
											handler:function(){
												bd.layout.layout('remove', 'south');
											}    
										}],
										collapsedContent: function(title){
											var region = $(this).panel('options').region;
											if(region =='east'|| region =='center'){
												//返回标题;
											} else {
												return '<div class="panel-title layout-expand-title-down">销售订单</ div>';
											}
										},
										onCollapse: function(){
											bd.layout.find('.layout-expand-south').find('.panel-header').css({'border-right':0,'border-left':0,'border-bottom':0})
											bd.layout.find('.layout-expand-south').find('.panel-body').css({'border-right':0,'border-left':0,'border-bottom':0})
										}
									});
									
									var trackgrid = $('<div>').appendTo(bd.layout.layout('panel', 'south')),
										toolbar = $('<div>'),
										searchtext = $('<div>').appendTo(toolbar),
										allselectbtn = $('<div>').appendTo(toolbar),
										cancelselectbtn = $('<div>').appendTo(toolbar),
										Reversalselectbtn = $('<div>').appendTo(toolbar),
										okbtn = $('<div>').appendTo(toolbar),
										closebtn = $('<div>'),//.appendTo(toolbar),
										okfn = function(d){
											if(!d)return;
											if(d.length == 0)return;
											var grid = bd.layout.layout('panel', 'center').find('.datagrid-f');
											if(d.length == 1){
												grid.datagrid('appendRow',{
													productid: d[0].productid,
													productname:d[0].productname,
													productcode:d[0].productcode,
													quantity:d[0].quantity,
													price:d[0].price,
													oldprice:d[0].oldprice,
													amount:d[0].price,
													spec:d[0].spec,
													aunit:d[0].aunit,
													taxrate:d[0].taxrate,
													taxamount:d[0].price/(1+d[0].taxrate)*d[0].taxrate,
													famount:d[0].price
												});
												grid.datagrid('scrollTo', grid.datagrid('getData').total - 1);//滚动到新增的行
												grid.datagrid('selectRow', grid.datagrid('getData').total - 1);
											}else{
												var data = grid.datagrid('getData');
												if(data.firstRows){
													data = data.firstRows;
												}else{
													data = data.rows;
												}
												for(var i in d){
													data.push({
														productid: d[i].productid,
														productname:d[i].productname,
														productcode:d[i].productcode,
														quantity:d[i].quantity,
														price:d[i].price,
														oldprice:d[i].oldprice,
														amount:d[i].price,
														spec:d[i].spec,
														aunit:d[i].aunit,
														taxrate:d[i].taxrate,
														taxamount:d[i].price/(1+d[i].taxrate)*d[i].taxrate,
														famount:d[i].price
													})
												}
												grid.datagrid('loadData',{total:data.length, rows:data});
											}
											ebx.setEditstatus(bd.tab, true);
										};
									
									$.ajax({
										type: 'post', 
										url: 'server/SimpChinese/DataProvider/style/',
										data: {style:'ProductSaleTrack',_:(new Date()).getTime()},
										dataType: "json",
										success: function(result){
											if(result){
												var columnsData = [result.data];
												ebx.setListVies(columnsData[0]);
												trackgrid.datagrid({
													view:scrollview,
													pageSize:ebx.pagesize,
													remoteSort:true,
													rownumbers:true,
													singleSelect:false,
													pagination:false,
													fitColumns:false,
													striped:true,
													nowrap:true,//禁用自动换行
													url:'server/SimpChinese/saleoutstock/gettrack/',
													method:'post',
													queryParams: {id: customid, _: (new Date()).getTime()},
													toolbar: toolbar,
													multiSort:false,
													checkOnSelect:false,
													checkOnSelect:true,
													columns:columnsData,
													height: '100%',
													//width: '100%',
													border:result.bd[0].border,
													showFooter:result.bd[0].footer,
													showHeader:result.bd[0].header,
													onClickCell:function(index, row){},
													onDblClickRow:function(index, row){
														okfn([row]);
														trackgrid.datagrid('deleteRow', index);
													}
												}).datagrid('renderformatterstyler');
											}
										}
									});
									searchtext.searchbox({ 
										searcher:function(value,name){ 
											trackgrid.datagrid('load', {
												id:customid,
												find: escape(value)
											})
										}, 
										prompt:'请输入搜索文本' 
									}); 
									allselectbtn.linkbutton({
										text:'全选',
										iconCls:'icon-TableInsertColumnsRightprvall',
										plain:true,
										onClick: function(){
											trackgrid.datagrid('checkAll');
										}
									});
									cancelselectbtn.linkbutton({
										text:'取消选中',
										iconCls:'icon-TableDelete',
										plain:true,
										onClick:function(){
											trackgrid.datagrid('uncheckAll');
										}
									});
									Reversalselectbtn.linkbutton({
										text:'反选',
										iconCls:'icon-Reversalselectbtn',
										plain:true,
										onClick: function(){
											var s = trackgrid.datagrid('getSelections');
											trackgrid.datagrid('checkAll');
											for(var i in s){
												trackgrid.datagrid('unselectRow', trackgrid.datagrid('getRowIndex', s[i]));
											}
										}
									});
									okbtn.linkbutton({
										text:'添加选中的行到单据',
										iconCls:'icon-arrow-up',
										plain:true,
										onClick: function(){
											var data = trackgrid.datagrid('getSelections')
											okfn(data);
											for(var i in data){
												trackgrid.datagrid('deleteRow',  trackgrid.datagrid('getRowIndex', data[i]));
											}
										}
									});
									closebtn.linkbutton({
										text:'关闭',
										iconCls:'icon-DeclineInvitation',
										plain:true,
										onClick: function(){
											bd.layout.layout('remove', 'south');
										}
									});
								}
							},{
						        text:'整单打折',
						        //iconAlign:'top',
						        //size:'large',
						        iconCls:'icon-GroupNumber',
								name:'discount',
						        onClick: function(){
									easyloader.load(['numberspinner','combobox'], function(){
										var win = $('<div style="text-align:center;">').appendTo('body'),
											discount = $('<div>').appendTo(win),
											target = $('<div>').appendTo(win),
											foot = $('<div style="padding:3px;text-align:center;">'),
											okbtn = $('<div>').appendTo(foot),
											cancelbtn = $('<div>').appendTo(foot);
										
										win.window({
											title: '整单折扣',
											width:200,    
											height:110, 
											maxWidth:'90%',
											maxHeight:'90%',
											modal:true,
											noheader:true,
											collapsible:false,
											minimizable:false,
											maximizable:false,
											resizable:false,
											border:'thin',
											shadow:false,
											footer: foot,
											onBeforeClose: function(){
												rediscount();
												win.remove();
											}
										}).css({'padding':10});
										
										$('body').find('.window-mask').on('click', function(){
											win.window('close');
										}); 

										discount.numberspinner({    
											min: 0,    
											max: 10,    
											editable: true,
											label:'折扣',
											precision: 2,
											increment: 0.1,
											value: bd.discount
										}); 
										
										target.combobox({
											label:'折扣参考',
											valueField: 'id',    
											textField: 'text',
											panelHeight: 'auto',
											value: ebx.discountprice,
											data:[{    
												"id":2,    
												"text":"单价"   
											},{    
												"id":1,    
												"text":"原单价"   
											}]
										});	

										okbtn.linkbutton({
											text: '确定',
											iconCls:'icon-AcceptTask',
											plain:true,
											onClick:function(){
												var v = target.combobox('getValue');
												ebx.discountprice = v
												ebx.storage.set("discountprice", {discountprice: v});
												bd.discount = discount.numberspinner('getValue');
												var grid = bd.layout.layout('panel', 'center').find('.datagrid-f'),
													data = grid.datagrid('getData');

												if(data.firstRows){
													data = data.firstRows;
												}else{
													data = data.rows;
												}
												for(var i in data){
													if(ebx.discountprice == 1){
														data[i].price = data[i].oldprice * bd.discount;
													}else{
														data[i].price = data[i].price * bd.discount;
													}
													data[i].amount = data[i].price * data[i].quantity;
													data[i].taxamount = data[i].amount / (data[i].taxrate + 1) * data[i].taxrate
													data[i].nat = data[i].amount - data[i].taxamount;
												}
												grid.datagrid('loadData', {total: data.length, rows: data});
												ebx.setEditstatus(bd.tab, true);
												win.window('close');
											}
										});
										cancelbtn.linkbutton({
											text: '取消',
											iconCls:'icon-DeclineInvitation',
											plain:true,
											onClick:function(){
												win.window('close');
											}
										});
										win.parent().find('.panel-footer').css({'border-left': 0,'border-bottom': 0,'border-right': 0});
										win.window('resize');
									});
								}
							},{
						        text:'收款方式',
						        //iconAlign:'top',
						        //size:'large',
						        iconCls:'icon-AccountingFormat',
						        onClick: function(){
							        if(ebx.validInt(bd.ID) == 0){
								        $.messager.show({
									        title: '提示',
									        msg: '请先保存 ' + bd.Parament.text + '！',
									        timeout: 3000,
									        showType: 'slide'
								        });
								        return;
							        }
							        var win = $('<div>').appendTo('body'),
								        toolbar = $('<div>'),
								        newbtn = $('<div>').appendTo(toolbar),
								        delbtn = $('<div>').appendTo(toolbar),
								        clearbtn = $('<div>').appendTo(toolbar),
								        savebtn = $('<div>').appendTo(toolbar),
								        grid = $('<div>').appendTo(win);
        							
							        win.window({
								        title: '收款方式',
								        width:300,    
								        height:400, 
								        maxWidth:'90%',
								        maxHeight:'90%',
								        modal:true,
								        collapsible:false,
								        minimizable:false,
								        maximizable:false,
								        resizable:false,
								        border:'thin',
								        shadow:false
							        });
							        $('body').find('.window-mask').on('click', function(){
								        win.window('close');
							        });
							        grid.datagrid({
								        view:scrollview,
								        pageSize:ebx.pagesize,
								        url:'/server/SimpChinese/saleoutstock/getpayment/',
								        queryParams:{
									        id:bd.ID,
									        _:(new Date()).getTime()
								        },
								        columns:[[    
									        {field:'payment',title:'收款方式',editor:'text',width:100},
									        {field:'amount',title:'金额',editor:'text',width:100,fieldstyle:'text-align:right;',render:'currencyRender'}
								        ]],
								        toolbar: toolbar,
								        border: false,
								        height:'100%',
								        width:'100%',
								        rownumbers:true,
								        singleSelect:true,
								        striped:true,
								        //ctrlSelect:true,
								        fitColumns:true
							        }).datagrid('renderformatterstyler');
        							
							        newbtn.linkbutton({
								        text:'新行',
								        iconCls:'icon-CellsInsertDialog',
								        plain:true,
								        onClick: function(){
									        grid.datagrid('appendRow', {});
									        grid.datagrid('selectRow', grid.datagrid('getData').total - 1);
									        grid.datagrid('editkeyboard', {index: grid.datagrid('getData').total - 1, field:'payment'});
								        }
							        });
							        delbtn.linkbutton({
								        text:'删行',
								        iconCls:'icon-CellsDelete',
								        plain:true,
								        onClick: function(){
									        var index = grid.datagrid('getRowIndex', grid.datagrid('getSelected'));
									        if(index < 0){
										        $.messager.show({
											        title: '提示',
											        msg: '请先选中一行。',
											        timeout: 3000,
											        showType: 'slide'
										        });									
										        return;
									        }
									        $.messager.confirm('确认对话框', '您想要删除吗？删除操作后数据将无法恢复。', function(r){
										        if (r){
											        grid.datagrid('deleteRow', index);
											        if(index >= grid.datagrid('getData').total && index > 0) index--;
											        if(grid.datagrid('getData').total == 0 || index < 0){
												        grid.datagrid('loadData', { total: 0, rows: [] }); 
											        }else{
												        grid.datagrid('selectRow', index);
											        }
										        }
									        });
								        }
							        });
							        clearbtn.linkbutton({
								        text:'清空',
								        iconCls:'icon-TableDelete',
								        plain:true,
								        onClick: function(){
									        $.messager.confirm('确认对话框', '您想要清空吗？清空操作后数据将无法恢复。', function(r){
										        if (r){
											        grid.datagrid('loadData', { total: 0, rows: [] }); 
										        }
									        });
								        }
							        });
							        savebtn.linkbutton({
								        text:'保存',
								        iconCls:'icon-FileSave',
								        plain:true,
								        onClick:function(){
									        $.messager.progress({title:'正在保存...',text:''}); 
									        var data = grid.datagrid('getData'),
										        datastr = ebx.convertDicToJson(data);
        										
									        $.ajax({
										        type: 'post', 
										        url: 'server/SimpChinese/saleoutstock/setpayment/',
										        data: {id: bd.ID, bd: datastr, _:(new Date()).getTime()},
										        dataType: "json",
										        success: function(result){
											        $.messager.progress('close');
											        if(result.result){
												        $.messager.show({
													        title: '提示',
													        msg: '收款方式保存成功！',
													        timeout: 3000,
													        showType: 'slide'
												        });
												        grid.datagrid('load');
											        }else{
												        $.messager.alert({
													        title: '错误',
													        msg: result.msg,
													        timeout: 3000,
													        showType: 'slide'
												        });
											        }
										        }
									        });
								        }
							        });
						        }
					        }]
				        }]
			        });
					function rediscount(){
						return;//窄屏显示效果较差，暂停提示
						var discountbtn = ebx.getbiribbonobj(bd.biribbon, 'discount', 'linkbutton');
						if(discountbtn){
							discountbtn.tooltip({
								position: 'right',
								content: '折扣：' + bd.discount + '<br>参考：'+(ebx.discountprice==1?'原单价':'单价'),
								onShow: function(){
									//$(this).tooltip('tip').addClass('bdtip');
								}
							}).tooltip('show');
						}
					}
					setTimeout(function(){
						rediscount();
					}, 0);
		        },
		        east: function(c, s){//表头区域（load）回掉函数
		            ebx.setDatagridEditor.editorMethods(c.rows, 'custom', 'combogrid', {//用来重造客户的combogrid得方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'organization'){
						            r[i].value = rowData.id;
					            }
				            }
							bd.layout.layout('remove', 'south');
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'organization'){
						                r[i].value = 0;
					                }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'stockname', 'combogrid', {//用来重造仓库的combogrid的方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'stock'){
						            r[i].value = rowData.id;
					            }
				            }
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'stock'){
						                r[i].value = 0;
					                }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'operatorname', 'combogrid', {//用来重造业务员的combogrid的方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'operator'){
						            r[i].value = rowData.id;
					            }
				            }
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'operator'){
						                r[i].value = 0;
					                }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'InvoiceTypename', 'combogrid', {//用来重造发票类型的combogrid的方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'InvoiceType'){
						            r[i].value = rowData.id;
					            }
				            }
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'InvoiceType'){
						                r[i].value = 0;
					                }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'VIPCustomname', 'combogrid', {//用来重造会员的combogrid的方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'VIPCustomID'){
						            r[i].value = rowData.id;
					            }
				            }
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'VIPCustomID'){
						                r[i].value = 0;
					                }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'Currencyname', 'combogrid', {//用来重造币种的combogrid的方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'Currency'){
						            r[i].value = rowData.id;
					            }
					            if(r[i].field == 'Relation'){
						            r[i].value = rowData.relation;
						            s.datagrid('refreshRow', i);
					            }
				            }
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'Currency'){
						                r[i].value = 0;
					                }
				                    if(r[i].field == 'Relation'){
					                    r[i].value = 1;
					                    s.datagrid('refreshRow', i);
				                    }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'CheckTypename', 'combogrid', {//用来重造结算方式的combogrid的方法
			            onSelect: function(rowIndex, rowData){//选中后更新当前行的内容为选中内容
				            var r = s.datagrid('getData').rows;
				            for(var i in r){
					            if(r[i].field == 'CheckType'){
						            r[i].value = rowData.id;
					            }
				            }
			            },
			            onChange: function(newValue, oldValue){
			                if(newValue == ''){
				                var r = s.datagrid('getData').rows;
				                for(var i in r){
					                if(r[i].field == 'CheckType'){
						                r[i].value = 0;
					                }
					            }
				            }
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'InvoiceNum', 'textbox', {//用来重造发票号码的onClickButton的方法
			            onClickButton: function(){//选中后更新当前行的内容为选中内容
				            var InvoiceNum = this.value,
					            rows = bd.eaststorage.datagrid('getRows'),
					            InvoiceType = 0,
					            InvoiceMemo = '';
        						
				            for(var i in rows){
					            if(rows[i].field){
						            if(rows[i].field.toString().length > 0){
							            if(rows[i].field.toLowerCase() === 'invoicetype'){
								            InvoiceType = ebx.validInt(rows[i].value);
							            }
							            if(rows[i].field.toLowerCase() === 'invoicememo'){
								            InvoiceMemo = rows[i].value;
							            }
						            }
					            }
				            }	
				            if(InvoiceType == 0){
					            $.messager.alert('错误', '请选择发票类型！', 'error');	
					            return;
				            };
				            if(ebx.validInt(bd.ID) == 0){
					            $.messager.show({
						            title: '提示',
						            msg: '请先保存单据。',
						            timeout: 3000,
						            showType: 'slide'
					            });
					            return;
				            }
				            $.messager.progress({title:'正在保存...',text:''});
				            $.ajax({
					            type: 'post', 
					            url: 'server/SimpChinese/saleoutstock/saveInvoiceNum/',
					            data: {id: bd.ID, invoicenum: escape(InvoiceNum),invoicetype: InvoiceType, invoicememo: escape(InvoiceMemo), _:(new Date()).getTime()},
					            dataType: "json",
					            success: function(result){
						            $.messager.progress('close');
						            if(result.result){
							            $.messager.show({
								            title: '提示',
								            msg: '发票信息保存成功！',
								            timeout: 3000,
								            showType: 'slide'
							            });
							            bd.eaststorage.datagrid('load');
							            ebx.setEditstatus(bd.tab, false);
						            }else{
							            $.messager.alert('错误', '保存失败！' + result.msg, 'error');	
						            }
					            }
				            });
        					
			            }
		            });
        			
		            ebx.setDatagridEditor.editorMethods(c.rows, 'InvoiceMemo', 'textbox', {//用来重造发票好嘛的onClickButton的方法
			            onClickButton: function(){//选中后更新当前行的内容为选中内容
				            var InvoiceNum = '',
					            rows = bd.eaststorage.datagrid('getRows'),
					            InvoiceType = 0,
					            InvoiceMemo = this.value;
        						
				            for(var i in rows){
					            if(rows[i].field){
						            if(rows[i].field.toString().length > 0){
							            if(rows[i].field.toLowerCase() === 'invoicetype'){
								            InvoiceType = ebx.validInt(rows[i].value);
							            }
							            if(rows[i].field.toLowerCase() === 'invoicenum'){
								            InvoiceNum = rows[i].value;
							            }
						            }
					            }
				            }	
				            if(InvoiceType == 0){
					            $.messager.alert('错误', '请选择发票类型！', 'error');	
					            return;
				            };
				            if(ebx.validInt(bd.ID) == 0){
					            $.messager.show({
						            title: '提示',
						            msg: '请先保存单据。',
						            timeout: 3000,
						            showType: 'slide'
					            });
					            return;
				            }
				            $.messager.progress({title:'正在保存...',text:''});
				            $.ajax({
					            type: 'post', 
					            url: 'server/SimpChinese/saleoutstock/saveInvoiceNum/',
					            data: {id: bd.ID, invoicenum: escape(InvoiceNum),invoicetype: InvoiceType, invoicememo: escape(InvoiceMemo), _:(new Date()).getTime()},
					            dataType: "json",
					            success: function(result){
						            $.messager.progress('close');
						            if(result.result){
							            $.messager.show({
								            title: '提示',
								            msg: '发票信息保存成功！',
								            timeout: 3000,
								            showType: 'slide'
							            });
							            bd.eaststorage.datagrid('load');
							            ebx.setEditstatus(bd.tab, false);
						            }else{
							            $.messager.alert('错误', '保存失败！' + result.msg, 'error');	
						            }
					            }
				            });
        					
			            }
		            });
		        },
		        center: function(c, s){//明细回掉函数，datagrid加载前触发
			        ebx.setDatagridEditor.editorType(c[0], 'productname', 'droplist', {//用来选择菜单组的combogrid
				        style:'product',
				        //validType:'LetterInteger',
				        remoteSort:false,
				        required:true,
				        idField:'id',
				        idField:'productname',
				        rownumbers:true,
				        panelWidth:400,
				        panelHeight:300,
				        droplisturl:'server/SimpChinese/product/open/',
				        hasDownArrow:false,//隐藏右边得下箭头
				        //template:147,
				        onCheck: function(rowIndex,rowData){//选中后更新当前行的内容为选中内容
					        var r = s.datagrid('getData');
					        r.firstRows[s.datagrid('options').editIndex].serial = r.firstRows.length;
					        r.firstRows[s.datagrid('options').editIndex].productid = ebx.validInt(rowData.productid);
					        r.firstRows[s.datagrid('options').editIndex].productcode = rowData.productcode;
					        r.firstRows[s.datagrid('options').editIndex].spec = rowData.spec;
					        r.firstRows[s.datagrid('options').editIndex].unit = rowData.unit;
					        r.firstRows[s.datagrid('options').editIndex].aunit = rowData.aunit;
					        r.firstRows[s.datagrid('options').editIndex].oldprice = ebx.validFloat(rowData.detailprice);
					        r.firstRows[s.datagrid('options').editIndex].relation = ebx.validFloat(rowData.relation);
					        r.firstRows[s.datagrid('options').editIndex].aquantity = ebx.validFloat(rowData.relation * 1);
					        r.firstRows[s.datagrid('options').editIndex].quantity = 1;
					        r.firstRows[s.datagrid('options').editIndex].price = ebx.validFloat(rowData.detailprice);
					        r.firstRows[s.datagrid('options').editIndex].amount = ebx.validFloat(rowData.detailprice);
					        r.firstRows[s.datagrid('options').editIndex].taxrate = ebx.validFloat(rowData.taxrate);
					        r.firstRows[s.datagrid('options').editIndex].productserial = rowData.productserial;
					        r.firstRows[s.datagrid('options').editIndex].lengthserial = rowData.lengthserial;
							r.firstRows[s.datagrid('options').editIndex].taxamount = r.firstRows[s.datagrid('options').editIndex].amount / (r.firstRows[s.datagrid('options').editIndex].taxrate + 1) * r.firstRows[s.datagrid('options').editIndex].taxrate;
							r.firstRows[s.datagrid('options').editIndex].nat = r.firstRows[s.datagrid('options').editIndex].amount - r.firstRows[s.datagrid('options').editIndex].taxamount;
						}
			        });
        			
			        ebx.setDatagridEditor.editorType(c[0], 'Quantity', 'textbox', {//处理编辑数量时的运算
				        onChange: function(newValue, oldValue){
					        if(newValue != oldValue){
						        var data = s.datagrid('getData'),
							        r = s.datagrid('getSelected'),
							        index = s.datagrid('getRowIndex', r),
							        quantity = ebx.validFloat(newValue);

						        if(data.firstRows[index] != undefined){
							        var TaxRate = ebx.validFloat(data.firstRows[index].taxrate);
							        data.firstRows[index].aquantity = ebx.validFloat(data.firstRows[index].relation) * quantity;
							        data.firstRows[index].amount = ebx.validFloat(data.firstRows[index].price) * quantity;
							        if(TaxRate != -1){
								        data.firstRows[index].taxamount = data.firstRows[index].amount / (TaxRate + 1) * TaxRate;
							        }else{
								        data.firstRows[index].taxamount = 0;
							        }
							        data.firstRows[index].nat = data.firstRows[index].amount - data.firstRows[index].taxamount;
						        }
					        }
				        }
			        });
        			
			        ebx.setDatagridEditor.editorType(c[0], 'price', 'textbox', {//处理编辑数量时的运算
				        onChange: function(newValue, oldValue){
					        if(newValue != oldValue){
						        var data = s.datagrid('getData'),
							        r = s.datagrid('getSelected'),
							        index = s.datagrid('getRowIndex', r),
							        price = ebx.validFloat(newValue);
        						
						        if(data.firstRows[index] != undefined){
							        var TaxRate = ebx.validFloat(data.firstRows[index].taxrate);
							        data.firstRows[index].amount = ebx.validFloat(data.firstRows[index].quantity) * price
							        if(TaxRate != -1){
								        data.firstRows[index].taxamount = data.firstRows[index].amount / (TaxRate + 1) * TaxRate;
							        }else{
								        data.firstRows[index].taxamount = 0;
							        }
							        data.firstRows[index].nat = data.firstRows[index].amount - data.firstRows[index].taxamount;
						        }
					        }
				        }
			        });
        			
			        ebx.setDatagridEditor.editorType(c[0], 'amount', 'textbox', {//处理编辑金额时的运算
				        onChange: function(newValue, oldValue){
					        if(newValue != oldValue){
						        var data = s.datagrid('getData'),
							        r = s.datagrid('getSelected'),
							        index = s.datagrid('getRowIndex', r),
							        amount = ebx.validFloat(newValue);
        						
						        if(data.firstRows[index] != undefined){
							        var quantity = ebx.validFloat(data.firstRows[index].quantity),
								        TaxRate = ebx.validFloat(data.firstRows[index].taxrate);
							        if(quantity == 0){
								        data.firstRows[index].price = 0
							        }else{
								        data.firstRows[index].price = amount/quantity;
							        }
							        if(TaxRate != -1){
								        data.firstRows[index].taxamount = data.firstRows[index].amount / (TaxRate + 1) * TaxRate;
							        }else{
								        data.firstRows[index].taxamount = 0;
							        }
							        data.firstRows[index].nat = data.firstRows[index].amount - data.firstRows[index].taxamount;
						        }
					        }
				        }
			        });
        			
			        ebx.setDatagridEditor.editorType(c[0], 'expire', 'datebox', {});//处理质保期

			        ebx.setDatagridEditor.editorType(c[0], 'ProductSerial', '', {});//清除串号编辑功能
			        ebx.setDatagridEditor.editorType(c[0], 'ColorSize', '', {});//清除色码编辑功能
			        ebx.setDatagridEditor.editorType(c[0], 'ProductCode', '', {});//清除串号编辑功能
        			
			        ebx.setDatagridEditor.setColumnsFunc(c[0], 'expire', 'cbRSDate');//写入服务器端用回掉函数
		        },
		        center1: function(s){//明细回掉函数1，datagrid加载后触发
			        s.datagrid('options').onClickCell = function(index, field, value){
				        switch(field.toLowerCase()){//处理串号编辑
					        case 'productserial':
						        var productserialopen = ebx.cloneObj(ebx.productserial),//复制产品串号编辑对象
							        row = s.datagrid('getData').firstRows[index];
						        //productserialopen.open(row.productname, row.lengthserial, s, index);
						        productserialopen.open(row.productname, row.lengthserial, s, index);
						        break;
					        case 'colorsize':
						        var colorsizeopen = ebx.cloneObj(ebx.colorsize),//复制产品色码编辑对象
							        row = s.datagrid('getData').firstRows[index];
						        colorsizeopen.init(row.productname, s, index, bd.tab);
						        colorsizeopen.open();
						        break;
					        default:
						        var opts = s.datagrid('options');
						        if(opts.editIndex>=0){
							        s.datagrid('endEdit', opts.editIndex);
						        }
						        s.datagrid('selectRow', index).datagrid('editkeyboard', {index:index,field:field});
						        opts.editIndex = index
						        break;
				        }
			        }
			        s.datagrid('options').onRowContextMenu = function(e, rowIndex, rowData){//鼠标右键处理方法
				        if(rowIndex < 0)return;
				        d = $(this);
				        d.datagrid('selectRow', rowIndex)
				        e.preventDefault();
				        var RowContextMenu = $('<div>');
				        RowContextMenu.menu({
					        width:100
				        }).menu('appendItem', {
					        text: '查看库存',
					        iconCls: 'icon-ChartTypePieInsertGallery',
					        disable:true,
					        onclick:function(){
						        if(ebx.validInt(rowData.productid) == 0){
							        $.messager.show({
								        title: '错误',
								        msg: '请选择产品。',
								        timeout: 3000,
								        showType: 'slide'
							        });
							        return;
						        }
						        var win = $('<div>').appendTo($('body')),
							        stockquery = $('<div>').appendTo(win);
						        win.window({
							        title: rowData.productname + ' 的库存',
							        width:800,    
							        height:600, 
							        maxWidth:'90%',
							        maxHeight:'90%',
							        modal:true,
							        collapsible:false,
							        minimizable:false,
							        maximizable:false,
							        resizable:false,
							        border:'thin',
							        shadow:false
						        });
						        $('body').find('.window-mask').on('click', function(){
							        win.window('close');
						        });
						        $.ajax({
							        type: 'post', 
							        url: 'server/SimpChinese/DataProvider/style/',
							        data: {style:'ItemBatch',_:(new Date()).getTime()},//style名称必须和mode相吻合
							        dataType: "json",
							        success: function(result){
								        if(result){
									        columnsData = [result.data];
									        ebx.setListVies(columnsData[0]);
									        stockquery.datagrid({
										        view:scrollview,
										        pageSize:ebx.pagesize,
										        remoteSort:false,
										        rownumbers:true,
										        singleSelect:true,
										        pagination:false,
										        border:false,
										        fit:false,
										        fitColumns:false,
										        striped:true,
										        data:{total:0,rows:[]},
										        url:'server/SimpChinese/product/stock/',
										        nowrap:true,//禁用自动换行
										        method:'post',
										        queryParams:{_:(new Date()).getTime(),id:rowData.productid,listview:ebx.convertDicToJson(ebx.listview)},
										        multiSort:false,
										        checkOnSelect:false,
										        columns:columnsData,
										        height: '100%',
										        border:result.bd[0].border,
										        showFooter:result.bd[0].footer,
										        showHeader:result.bd[0].header
									        }).datagrid('renderformatterstyler');//启用显示式样回调函数
								        }
							        }
						        });
					        }
				        }).menu('appendItem', {
					        text: '删除',
					        iconCls: 'icon-Delete',
					        disabled:rowData.auditid?true:(rowData.isdeleted?true:false),
					        onclick: function(){
						        $.messager.confirm('确认对话框', '您想要删除吗？删除操作后数据将无法恢复。', function(r){
							        if (r){
								        d.datagrid('deleteRow', rowIndex);						
								        ebx.setEditstatus(bd.tab, true);
							        }
						        });
					        }
				        }).menu('show', {
					        left: e.pageX,
					        top: e.pageY
				        });
			        }
		        }
		    };
		    
		bd._export = function(){//重造导入方法
			$.messager.alert({
				title: '错误',
				msg: '不支持导入。',
				timeout: 3000,
				showType: 'slide'
			});
		}
		bd.billtype = 1306;//单据类型赋值，用于附件支持
		bd.showAudit = 1;//显示审核按钮
		bd.showPrint = 1;//显示打印功能组
		bd.showSearchserial = 1;//显示串号扫描输入框
		bd.init(callback);
	});
</script>
