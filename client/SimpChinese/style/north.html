<script type="text/javascript">
	easyloader.load([], function(){
		var tabs = ebx.center.tabs('getSelected'),
			tab = tabs.panel('options'),
			layout = tabs.find('.layout'),
			northPanel = layout.layout('panel', 'north'),
			Paramet = ebx.getMenuParameter(tabs),
			biribbon = $('<div>').appendTo(northPanel),
			data = {
				selected:0,
				tabs:[{
					title:'开始',
					groups:[{
						title:'基本操作',
						tools:[{
							type:'splitbutton',
							name:'save',
							text:'保存',
							iconCls:'icon-FileSave-large',
							iconAlign:'top',
							size:'large',
							menuItems:[{
								name:'saveas',
								text:'另存为',
								iconCls:'icon-FileSaveAs'
							}],
							onClick: function(){
								var saveBtn = $(this);
								
								saveBtn.linkbutton('disable');
								
								var bdlist = layout.layout('panel', 'center').find('.datagrid-f').datagrid('getData'),
									bd = layout.layout('panel', 'east').find('.datagrid-f').datagrid('getData'),
									bdliststr =  ebx.convertDicToJson(bdlist),
									bdstr = ebx.convertDicToJson(bd),
									parameter = {bd: bdstr, bdlist: bdliststr, _: (new Date()).getTime()};
									
								if(!ebx.checkedBDvalidatebox(layout.layout('panel', 'east').find('.datagrid-f'))){//校验必填项
									saveBtn.linkbutton('enable');
									return;
								}
								
								$.ajax({
									type: 'post', 
									url: 'server/' + Paramet.mode + '/save/',
									data: parameter,
									dataType: "json",
									success: function(result){
										//console.log(result);
										$.messager.show({
											title: '提示',
											msg: '保存成功！',
											timeout: 3000,
											showType: 'slide'
										});	
										layout.layout('panel', 'center').find('.datagrid-f').datagrid('loadData', result.bdlist);
										layout.layout('panel', 'east').find('.propertygrid-f').propertygrid('loadData', result.bd);
										saveBtn.linkbutton('enable');
									}
								});
							}
						},{
							type:'toolbar',
							dir:'v',
							tools:[{
								name:'new',
								text:'新建',
								iconCls:'tree-file',
								onClick: function(){
									setTimeout(function(){
										ebx.biedit();
									},0);
								}
							},{
								name:'delete',
								text:'删除',
								iconCls:'icon-Delete'
							},{
								name:'recovery',
								text:'恢复',
								iconCls:'icon-reload'
							}]
						}]
					},{
						title:'行操作',
						tools:[{
							name:'copy',
							text:'新行',
							iconCls:'icon-CellsInsertDialog-large',
							iconAlign:'top',
							size:'large',
							onClick:function(){
								var listdatagrid = layout.layout('panel', 'center').find('.datagrid-f');
								listdatagrid.datagrid('appendRow',{});
								listdatagrid.datagrid('scrollTo', listdatagrid.datagrid('getData').total - 1);//滚动到新增的行
								listdatagrid.datagrid('selectRow', listdatagrid.datagrid('getData').total - 1);
								listdatagrid.datagrid('editkeyboard', {index: listdatagrid.datagrid('getData').total - 1, field: listdatagrid.datagrid('options').columns[0][0].field}); //自动触发编辑第一个字段
								tab.editstatus = true;
								//listdatagrid.datagrid('reload');
							}
						},{
							type:'toolbar',
							dir:'v',
							tools:[{
								name:'deleterow',
								text:'删行',
								//disabled: true,
								iconCls:'icon-CellsDelete',
								onClick:function(){
									var listdatagrid = layout.layout('panel', 'center').find('.datagrid-f'),
										index = listdatagrid.datagrid('getRowIndex', listdatagrid.datagrid('getSelected'));
									if(index < 0){
										$.messager.show({
											title: '提示',
											msg: '请先选中一行。',
											timeout: 3000,
											showType: 'slide'
										});									
										return;
									}
									listdatagrid.datagrid('deleteRow', index);

									if(index >= listdatagrid.datagrid('getData').total && index > 0) index--;
									
									if(listdatagrid.datagrid('getData').total == 0 || index < 0){
										listdatagrid.datagrid('load', { total: 0, rows: [] }); 
									}else{
										listdatagrid.datagrid('selectRow', index);
									}
									
									tab.editstatus = true;
								}
							},{
								name:'empty',
								text:'清空',
								iconCls:'icon-TableDelete',
								onClick:function(){
									var listdatagrid = layout.layout('panel', 'center').find('.datagrid-f'),
										total = listdatagrid.datagrid('getData').total;
									listdatagrid.datagrid('load', { total: 0, rows: [] }); 
									tab.editstatus = true;
								}
							}]
						}]
					},{
						title:'内容',
						tools:[{
							type:'splitbutton',
							name:'paste',
							text:'粘贴',
							iconCls:'icon-Paste-large',
							iconAlign:'top',
							disabled: ebx.copyData?false:true,
							size:'large',
							onClick:function(){
								ebx.paste(layout.layout('panel', 'center').find('.datagrid-f'), tab)
							},
							menuItems:[{
								name:'reomvecopyData',
								text:'清除内容',
								iconCls:'icon-Delete',
								onClick: function(){
									ebx.reomvecopyData();
								}
							}]
						},{
							name:'copy',
							text:'复制',
							iconCls:'icon-Copy-large',
							size:'large',
							iconAlign:'top',
							onClick:function(){
								ebx.copy(layout.layout('panel', 'center').find('.datagrid-f'));
							}
						},{
							type:'toolbar',
							dir:'v',
							tools:[{
								name:'cut',
								text:'剪切',
								iconCls:'icon-edit-cut',
								onClick:function(){
									ebx.cut(layout.layout('panel', 'center').find('.datagrid-f'));
								}
							},{
								name:'ImportExcel',
								text:'导出',
								iconCls:'icon-ImportExcel',
								onClick:function(){
									var columns = layout.layout('panel', 'center').find('.datagrid-f').datagrid('options').columns,
										data =  layout.layout('panel', 'center').find('.datagrid-f').datagrid('getData');
									ebx.clipboardData(columns, data);
								}
							},{
								type:'splitbutton',
								name:'ExportExcel',
								text:'导入',
								iconCls:'icon-ExportExcel',
								menuItems:[{
									name:'FileSaveAsExcelXlsx',
									text: '导入模板',
									iconCls:'icon-FileSaveAsExcelXlsx',
									onclick:function(){
										var columns = layout.layout('panel', 'center').find('.datagrid-f').datagrid('options').columns;
										ebx.importTemplate(columns, Paramet.text);
									}
								}],
								onClick: function(){
									var ExportBtn = $(this);
									
									ebx.importExcel.fileinput = $('<input type="file" accept=".xls,.xlsx">').appendTo('body');
									ebx.importExcel.fileinput.change(function(){
										ExportBtn.linkbutton('disable');
										ebx.importExcel.datagridObj = layout.layout('panel', 'center').find('.datagrid-f');
										ebx.importExcel.tabObj = tab;
										ebx.importExcel.btnObj = ExportBtn;
										ebx.importExcel.getFile(this);
									});
									ebx.importExcel.fileinput.trigger("click");
								}
							}]
						}]
					},{
						title:'安全',
						tools:[{
							type:'toolbar',
							tools:[{
								name:'lock',
								text:'编辑锁',
								iconCls:'icon-Lock-large',
								iconAlign:'top',
								size:'large'
							}]
						}]
					}]
				}]
			};
			
		biribbon.ribbon({
			data:data,
			width:'100%',
			height:'100%',
			border: false,
			plain:true
		});

	});
</script>
